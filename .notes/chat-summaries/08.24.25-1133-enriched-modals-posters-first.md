# Enriched Modals (Posters-First) — Chat Summary

## Original Goal
Add enrichment data for recommended titles without delaying posters: IMDb ID, ratings (IMDb/RT/Metacritic), US streaming providers, duration, trailer, genres, director. Support staged responses: conversational mode and structured picks.

## Challenges
- Avoid blocking posters while fetching enrichment
- Choosing where to integrate (tRPC vs tool) and when to trigger (click vs visible)
- Provider naming inconsistencies (HBO Max vs Max, Prime Video variants)
- ESM/Jest config friction in a Next/TypeScript project

## What Worked
- Separate tRPC `enrichment.enrich` endpoint (posters-first)
- Trigger enrichment on poster visibility (IntersectionObserver) in `MovieCard`
- Robust fetchers with caps (3s background), partial results, and logging
- Provider whitelist + normalization and cap to 5
- Network smoke script across ~30 IDs to verify real-world behavior
- Unit tests for pure helpers

## What Didn’t Work
- Initial idea to add enrichment inside `media_lookup` (would delay posters)
- Early Jest config using TS ESM directly (switched to `jest.config.cjs` and pure helper module)

## Key Code Changes
- tRPC router: `src/server/api/routers/enrichment.ts`
  - fetchExternalIds → `imdbId`
  - fetchOmdbRatings → `{ imdb, rottenTomatoes, metacritic }`
  - fetchWatchProviders → `{ country: 'US', link?, flatrate[0..5] }` with whitelist order
  - fetchDetails → `duration` (movie runtime/tv episode_run_time[0]) + `genres` (first 2)
  - fetchTrailer → best YouTube trailer (prefer `official`)
  - fetchDirector → movie director / tv most frequent director (aggregate)
  - Returns partials; 3s caps; console logs
- Client: `src/app/_components/client/MovieCard.tsx`
  - IntersectionObserver triggers `api.enrichment.enrich.useQuery({ type, id })` when visible
- Helper module: `src/server/api/enrichment-helpers.ts`
  - `normalizeProviderName`, `filterProviders`, `parseRatings`, `pickBestTrailer`
- Tests:
  - Unit: `tests/server/enrichment.helpers.test.ts` (12 tests, all passing)
  - Network smoke: `scripts/smoke-enrichment.mjs` (hits ~30 IDs, validates shape/whitelist/caps)
- Action Plan: `.notes/action-plans/08.23.25-1452-enriched-modals-posters-first-master-plan.md`
  - Updated with extended fields, frontend consumption guide, and testing commands

## Pseudocode (Enrich Orchestration)
```
parallel: ext=external_ids, watch=watch/providers, det=details, vid=videos, dir=credits
if (ext.imdbId) ratings=omdb(imdbId)
return {
  imdbId: ext.imdbId?,
  ratings?,
  watch?,
  duration: det.duration?,
  genres: det.genres?,
  trailer: pickBest(vid.results)?,
  director: dir.name?
}
```

## Successes
- Posters remain instant; enrichment is progressive and reliable
- Real-network verification shows correct imdbId, ratings, providers (whitelisted), trailers, and metadata
- Frontend path is documented and ready for modal work
