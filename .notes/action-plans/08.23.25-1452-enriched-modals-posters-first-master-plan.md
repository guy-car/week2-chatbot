# Action Plan: Posters-First Enriched Modals (Master, Demo-Focused)

## 0. Guiding Principles & Execution Protocol (NEW)
> This preamble is mandatory. Follow exactly. If a step is impossible, stop and report.

1. Immutable plan; if blocked, stop and report.
2. Documentation is law: Use official TMDB and OMDb docs; mirror their field names.
3. Posters-first: Never delay poster rendering for enrichment.
4. Non-blocking enrichment: Run enrichment after cards render; partials are acceptable.
5. Partial results only: Omit unavailable/unfinished fields; do not throw; no nulls.
6. Timeouts as caps: Each sub-fetch has a per-call cap (see below). After cap, return without that section.
7. Two LLM modes: A) Conversational-only; B) Short NL rationale + up to 3 picks (posters-first). Do not wait for enrichment.
8. Additive only: No breaking changes. Leave existing routes/flows intact.
9. Manual verification: Use console logs for each step; no automated tests.
10. Accessibility & UX: Modal opens instantly; progressive sections; no blocking spinners; focus trap and ESC/backdrop close.

---

## 1. Overall Goal
Deliver a posters-first UX that progressively enriches movie/TV modals with IMDb ID, ratings (Rotten Tomatoes, Metacritic, IMDb), US stream providers, duration, trailer, genres, and director.
- A: Conversational-only (no picks)
- B: Short NL rationale + up to 3 structured picks (render posters immediately), while enrichment loads in background

Not in scope: Redis caching, rent/buy/ads, deep links, migrating legacy REST to tRPC, automated tests.

---

## 2. Regression Risks & Mitigation
- External slowness → Per-sub-fetch caps; partials allowed; modal never blocked.
- Env misconfig → Require `TMDB_API_KEY` and `OMDB_API_KEY` present; log which are used.
- Over-fetching unseen cards → Trigger enrichment only after card is rendered/visible.
- UI jank → Use subtle placeholders; hide or label "Unavailable" after grace period.

---

## Build & Checks Cadence
- After any code edits in Parts 1–4, run: `npm run check` (lint + typecheck). Fix issues before proceeding.
- Before demo, run: `npm run build` to verify production compile.

---

## 3. Structured Action & Verification Plan (IMPROVED STRUCTURE)

### Part 1: Backend Enrichment API (tRPC, additive)

Note: Keep the existing details route (`/{type}/{id}`) separate and unchanged (posters-first). Do not append `external_ids` there. Enrichment calls `/{type}/{id}/external_ids` after cards render.

- **Action 1.1:** Create `src/server/api/routers/enrichment.ts` and register in `src/server/api/root.ts`.
- **Verification 1.1:** Server compiles; router available in tRPC client types. Run `npm run check` and confirm no errors.

- **Action 1.2 (DONE):** Implement `enrich` query with: `imdbId`, `ratings`, `watch`, `duration`, `trailer`, `genres`, `director`.
  - Sub-fetchers with caps (3s prefetch):
    - `external_ids` → `imdbId`
    - `OMDb` (if `imdbId`) → ratings strings
    - `watch/providers` (US flatrate, whitelist + order, cap 5)
    - `details` → duration (movie runtime / tv episode_run_time[0]) + first 2 genres
    - `videos` → best YouTube trailer (prefer `official`)
    - `credits` / `aggregate_credits` → director (movie) / most frequent director (tv)
  - **Verification 1.2:** Curl a few IDs; confirm JSON contains expected fields; server logs show raw + parsed with timings. Run `npm run check`.

### Part 2: Prompt & Tool Policy (Two Modes, staged output)

- **Action 2.1:** Update prompt(s) for two modes:
  - Mode A: conversational-only answer.
  - Mode B: short NL rationale first, then call `media_lookup` (max 3). Do not wait for enrichment.
- **Verification 2.1:** Dry-run prompts; confirm NL rationale precedes picks; no enrichment waits. Run `npm run check`.

- **Action 2.2:** Adjust policy that previously prevented speaking before tools finish: allow emitting NL rationale and then structured picks as soon as `media_lookup` completes.
- **Verification 2.2:** Conversation logs show staged output. Run `npm run check`.

### Part 3: Client Posters-First + Background Prefetch

- **Action 3.1 (DONE):** Trigger enrichment only when BOTH are true:
  - A successful tool result exists (has `id` and `media_type`, no error), and
  - The poster element is mounted and visible (IntersectionObserver).
  - De-duplicate per `{type}:{id}` and skip if cached/in-flight.
- **Verification 3.1:** Enrichment does not run for items that never render. Run `npm run check`.

### Part 4: Modal Progressive Sections

- **Action 4.1:** Extend `MovieDetailsModal` to consume enrichment if available; hide sections when absent; no blocking spinners. Use subtle skeletons/placeholders that stop after ~5s.
- **Verification 4.1:** Visual pass on multiple titles; no layout jank; sections appear progressively. Run `npm run check`.

- **Action 4.2:** Providers row: show up to 5 whitelisted providers with logo `w92` and names; include TMDB `link` for the US section if present.
- **Verification 4.2:** Provider order and cap respected; link present when available. Run `npm run check`.

- **Action 4.3:** Ratings chips: show whatever sources are present; omit missing.
- **Verification 4.3:** Mixed presence scenarios render cleanly. Run `npm run check`.

- **Action 4.4:** Modal behavior: ~70% width, ~80vh, centered, blurred backdrop, light glass effect; ESC/X/backdrop close; focus trap; restore focus to originating poster.
- **Verification 4.4:** Keyboard and focus interactions verified manually. Run `npm run check`.

### Part 5: Telemetry (Console-only)

- **Action 5.1 (DONE):** Log per-segment durations, caps hit, and which env vars were used. Prefix logs to filter easily.
- **Verification 5.1:** Logs observed across smoke and ad-hoc calls.

---

## 4. Environment & Config
- Required: `TMDB_API_KEY`, `OMDB_API_KEY`.
- Timeouts: Prefetch caps 3s per sub-fetch; modal-retry caps 5s per sub-fetch.
- Provider whitelist order: Netflix, Amazon Prime Video, Disney+, Max, Hulu, Apple TV+, Peacock, Paramount+.
- Concurrency: At most 3 concurrent enrich calls per view.

---

## 5. Manual Checkpoints
- Backend enrich extended fields verified with curl.
- Network smoke passed: `node scripts/smoke-enrichment.mjs --port <devPort>` across ~30 IDs.
- Before demo: Run `npm run build`.

---

## 6. Frontend Consumption (How to Use the Data)
- Trigger fetch (already wired): when a poster becomes visible, call:
  - `api.enrichment.enrich.useQuery({ type: movie.media_type, id: movie.id }, { enabled: isVisible })`
- Modal presentation (when you build it):
  - Ratings: show available chips from `data.ratings` (IMDb, RT, Metacritic). Omit missing.
  - Providers: `data.watch?.flatrate` (0–5). Display whitelisted names and logoPath. Link to `data.watch.link` if present.
  - Duration: `data.duration` (minutes). For TV, may be absent.
  - Trailer: `data.trailer?.url` (YouTube). Optional "Watch trailer" button.
  - Genres: `data.genres` (0–2 strings).
  - Director: `data.director` for movies (TV may be missing).
- Progressive render:
  - Read from react-query cache; sections appear as data arrives.
  - If a section is still empty after ~5s, hide or show "Unavailable".

---

## 7. Rollback
- Feature is additive. To disable quickly, short-circuit the client trigger for enrichment and hide enrichment sections in the modal.

---

## 8. Testing
- Unit tests (helpers): `npm test`
  - Covers: provider normalization/filtering, ratings parsing, trailer selection
- Network smoke (non-optional):
  - Start dev: `npm run dev` (note port)
  - Run: `node scripts/smoke-enrichment.mjs --port <devPort>`
  - Expect: All cases print "- OK" lines; occasional "INFO" lines (e.g., no flatrate, missing TV duration/director) are acceptable.

---

## 9. Progress Update (Aug 25, 2025) and Route B Optimizations

### Current progress
- Mode A (conversational): Implemented and stable via AI SDK streaming; UI renders responses correctly.
- Mode B (recommendations): Implemented as plain JSON response (no streaming). Server resolves TMDB picks and returns `{ mode: 'B', text: intro, picks: MovieData[] }`.
- Client integration for Mode B (no streaming): UI now reads Mode B JSON in `onResponse` and immediately displays:
  - the short intro (as a synthetic assistant line), and
  - three posters (from `MovieData.poster_url`) without waiting for a streamed message.
- Planner steering: The latest user request is now included in the planning input (`userRequest`) so picks align with the user prompt (e.g., helicopters vs rom-coms).
- UX fix: Input and Send button are disabled only while submitted/streaming; they re-enable after Mode B responses.

### Gaps vs. modal goals
- Per-pick "why it's right for you" (the planner reason) is not yet exposed alongside each `MovieData` in the Mode B response.
- Mode B intro is returned only after TMDB lookups complete, so intro does not currently appear "early" without additional shaping.

### Route B optimization options (no streaming)
- Two-phase JSON (recommended without streaming):
  1) Phase 1 (immediate): Return `intro` and `plannedPicks` with `{ title, year, reason }` right after planning.
  2) Client renders intro and skeleton cards instantly, fires parallel TMDB lookups per pick, and fills posters as `poster_url` becomes available.
  3) Phase 2 (optional): Server can still persist `toolResults` in DB for history; client reconciles when available.

- Dedup and variety
  - Continue blocking by id (current) AND by title within the same chat to prevent repeat titles (year variants) when user intent changes.
  - Add light diversification pressure in planning instruction (e.g., "prefer variety of eras/regions/styles consistent with INPUT.userRequest").

- Latency small wins (server)
  - Keep taste profile + blocked list reads in parallel.
  - Ensure TMDB lookups run via `Promise.all` (already done); short-circuit missing posters fast.
  - Consider returning 204 on failures for individual lookups so client fills available posters without waiting.

### Streaming alternative (if we later want progressive UX)
- Stream the `intro` first, then stream three tool results (`media_lookup`) as each TMDB resolution completes. The existing client path already parses tool-invocation parts and would display posters one-by-one.

---

## 10. Modal Data Readiness Checklist

Each movie modal should display:
- title — source: `MovieData.title` (from TMDB search resolve)
- year — source: `MovieData.release_date` (first 4 chars), ensure fallback to planned `year`
- ratings — source: enrichment (OMDb) → `data.ratings`
- where to watch (providers) — source: enrichment (TMDB `watch/providers` US flatrate) → `data.watch`
- genre — source: enrichment (TMDB `details`) → first 1–2 genres → `data.genres`
- duration — source: enrichment (TMDB `details`) → `data.duration` (movie runtime or TV episode_run_time[0])
- director — source: enrichment (TMDB `credits`/`aggregate_credits`) → `data.director`
- why it's right for you — source: planner output per pick (`reason`); expose in Mode B response alongside each pick
- synopsis — source: `MovieData.overview` (TMDB); enrichment not required
- trailer link — source: enrichment (TMDB `videos`) → best YouTube trailer → `data.trailer.url`

Engineering notes:
- Enrichment router is already implemented; client triggers enrichment on poster visibility via react-query. Modal can consume enriched fields progressively (posters-first).
- For "why it's right for you," ensure the Mode B server response includes per-pick `{ title, year, reason }` (either embedded on each resolved pick or provided as a parallel `plannedPicks` array preserving order).
- Keep the modal resilient: render what’s available; hide or label unavailable sections after ~5s.
