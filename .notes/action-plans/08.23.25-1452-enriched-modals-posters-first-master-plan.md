# Action Plan: Posters-First Enriched Modals (Master, Demo-Focused)

## 0. Guiding Principles & Execution Protocol (NEW)
> This preamble is mandatory. Follow exactly. If a step is impossible, stop and report.

1. Immutable plan; if blocked, stop and report.
2. Documentation is law: Use official TMDB and OMDb docs; mirror their field names.
3. Posters-first: Never delay poster rendering for enrichment.
4. Non-blocking enrichment: Run enrichment after cards render; partials are acceptable.
5. Partial results only: Omit unavailable/unfinished fields; do not throw; no nulls.
6. Timeouts as caps: Each sub-fetch has a per-call cap (see below). After cap, return without that section.
7. Two LLM modes: A) Conversational-only; B) Short NL rationale + up to 3 picks (posters-first). Do not wait for enrichment.
8. Additive only: No breaking changes. Leave existing routes/flows intact.
9. Manual verification: Use console logs for each step; no automated tests.
10. Accessibility & UX: Modal opens instantly; progressive sections; no blocking spinners; focus trap and ESC/backdrop close.

---

## 1. Overall Goal
Deliver a posters-first UX that progressively enriches movie/TV modals with IMDb ID, ratings (Rotten Tomatoes, Metacritic, IMDb), and US stream providers. Support two initial assistant modes:
- A: Conversational-only (no picks)
- B: Short NL rationale + up to 3 structured picks (render posters immediately), while enrichment loads in background

Not in scope: Redis caching, rent/buy/ads, deep links, migrating legacy REST to tRPC, automated tests.

---

## 2. Regression Risks & Mitigation
- External slowness → Per-sub-fetch caps; partials allowed; modal never blocked.
- Env misconfig → Require `TMDB_API_KEY` and `OMDB_API_KEY` present; log which are used.
- Over-fetching unseen cards → Trigger enrichment only after card is rendered/visible.
- UI jank → Use subtle placeholders; hide or label "Unavailable" after grace period.

---

## Build & Checks Cadence
- After any code edits in Parts 1–4, run: `npm run check` (lint + typecheck). Fix issues before proceeding.
- Do not auto-run builds. Before the demo (and before merging), run: `npm run build` to verify production compile.

---

## 3. Structured Action & Verification Plan (IMPROVED STRUCTURE)

### Part 1: Backend Enrichment API (tRPC, additive)

Note: Keep the existing details route (`/{type}/{id}`) separate and unchanged (posters-first). Do not append `external_ids` there. Enrichment will call the dedicated `/{type}/{id}/external_ids` endpoint after cards render.

- **Action 1.1:** Create `src/server/api/routers/enrichment.ts` and register in `src/server/api/root.ts`.
- **Verification 1.1:** Server compiles; router available in tRPC client types. Run `npm run check` and confirm no errors.

- **Action 1.2:** Implement `enrich` query:
  - Input: `{ type: 'movie' | 'tv', id: number }`
  - Output shape (all fields optional, omit missing):
    ```
    {
      imdbId?: string,
      ratings?: { rottenTomatoes?: string; metacritic?: string; imdb?: string },
      watch?: { country: 'US'; link?: string; flatrate?: { id: number; name: string; logoPath: string }[] }
    }
    ```
  - Behavior: Run sub-fetchers with caps; allow partials; log raw + parsed.
- **Verification 1.2:** Call locally with known IDs; confirm payload shape and omissions for missing sections. Run `npm run check`.

- **Action 1.3:** Add `fetchExternalIds(type, id)` (TMDB `/{type}/{id}/external_ids`). Cap: 3s prefetch; 5s modal-retry.
  - Extract `imdb_id` if present; return `{ imdbId }` or `{}`.
  - Log: URL, duration, success, and extracted `imdb_id`.
- **Verification 1.3:** Console.log shows raw payload and `imdb_id` for one movie and one tv. Run `npm run check`.

- **Action 1.4:** Add `fetchOmdbRatings(imdbId)` (OMDb `?i={imdbId}&apikey={OMDB_API_KEY}`). Cap: 3s/5s.
  - Parse Ratings array into strings: RT (e.g., `87%`), Metacritic (e.g., `74/100`), IMDb (e.g., `7.8/10`). Omit missing ones.
  - Log: Raw response and parsed fields.
- **Verification 1.4:** Console.log parsed strings for a known title; handle missing sources gracefully. Run `npm run check`.

- **Action 1.5:** Add `fetchWatchProviders(type, id)` (TMDB `/{type}/{id}/watch/providers`). Cap: 3s/5s.
  - Extract `results.US`; whitelist providers and order: [Netflix, Prime Video, Max, Disney+, Hulu, Apple TV+, Peacock, Paramount+, Tubi, Freevee].
  - Keep only `flatrate`, cap to 5 entries, include TMDB `link`. Build logo URLs at size `w92` from `logo_path`.
  - Return `{ watch: { country: 'US', link?, flatrate? } }` (omit empty).
  - Log: Raw `results.US` and final filtered list.
- **Verification 1.5:** Console.log shows ordered, capped providers and link for a known title. Run `npm run check`.

- **Action 1.6:** Orchestrate `enrich`:
  - Start `external_ids` and `watch/providers` in parallel.
  - If `imdbId` arrives, start OMDb in parallel.
  - Await all in-flight with caps; compose partial response by omitting missing fields.
- **Verification 1.6:** Force timeouts (e.g., by lowering caps temporarily) and confirm partials return without errors. Run `npm run check`.

### Part 2: Prompt & Tool Policy (Two Modes, staged output)

- **Action 2.1:** Update prompt(s) for two modes:
  - Mode A: conversational-only answer.
  - Mode B: short NL rationale first, then call `media_lookup` (max 3). Do not wait for enrichment.
- **Verification 2.1:** Dry-run prompts; confirm NL rationale precedes picks; no enrichment waits. Run `npm run check`.

- **Action 2.2:** Adjust policy that previously prevented speaking before tools finish: allow the assistant to emit NL rationale and then structured picks as soon as `media_lookup` completes.
- **Verification 2.2:** Conversation logs show staged output without waiting on enrichment. Run `npm run check`.

### Part 3: Client Posters-First + Background Prefetch

- **Action 3.1:** Trigger enrichment only when BOTH are true:
  - A successful tool result exists (has `id` and `media_type`, no error), and
  - The poster element is mounted and visible (IntersectionObserver) — optionally wait for image `onLoad` once.
  Also: de-duplicate calls per `{type}:{id}` and skip if enrichment data already cached/in-flight.
- **Verification 3.1:** Enrichment does not run for items that never render. Run `npm run check`.

- **Action 3.2:** For each visible card, call `trpc.enrichment.enrich.query({ type, id })` in parallel (≤3 concurrent). Caps: 3s per sub-fetch on server.
- **Verification 3.2:** Posters appear immediately; logs show enrichment calls; no UI blocking. Run `npm run check`.

- **Action 3.3:** Cache enrichment by key `{type}:{id}` in client state; on unmount, avoid state updates; de-dupe in flight calls.
- **Verification 3.3:** No duplicate calls for the same visible item; no memory leaks. Run `npm run check`.

- **Action 3.4:** On modal open, if any section missing, fire a modal-retry enrichment with 5s caps; still non-blocking to modal display.
- **Verification 3.4:** Modal opens instantly; missing sections often appear within a few seconds. Run `npm run check`.

### Part 4: Modal Progressive Sections

- **Action 4.1:** Extend `MovieDetailsModal` to consume enrichment if available; hide sections when absent; no blocking spinners. Use subtle skeletons/placeholders that stop after ~5s.
- **Verification 4.1:** Visual pass on multiple titles; no layout jank; sections appear progressively. Run `npm run check`.

- **Action 4.2:** Providers row: show up to 5 whitelisted providers with logo `w92` and names; include TMDB `link` for the US section if present.
- **Verification 4.2:** Provider order and cap respected; link present when available. Run `npm run check`.

- **Action 4.3:** Ratings chips: show whatever sources are present; omit missing.
- **Verification 4.3:** Mixed presence scenarios render cleanly. Run `npm run check`.

- **Action 4.4:** Modal behavior: ~70% width, ~80vh, centered, blurred backdrop, light glass effect; ESC/X/backdrop close; focus trap; restore focus to originating poster.
- **Verification 4.4:** Keyboard and focus interactions verified manually. Run `npm run check`.

### Part 5: Telemetry (Console-only)

- **Action 5.1:** Log per-segment durations, caps hit, and which env vars were used. Prefix logs to filter easily.
- **Verification 5.1:** Review logs across several requests; confirm predictable timings and partials. Run `npm run check`.

---

## 4. Environment & Config
- Required: `TMDB_API_KEY`, `OMDB_API_KEY`.
- Timeouts: Prefetch caps 3s per sub-fetch; modal-retry caps 5s per sub-fetch.
- Provider whitelist order: Netflix, Prime Video, Max, Disney+, Hulu, Apple TV+, Peacock, Paramount+, Tubi, Freevee.
- Concurrency: At most 3 concurrent enrich calls per view.

---

## 5. Manual Checkpoints
- After Part 1.3–1.5: Verified console logs for external_ids, ratings, watch/providers with known IDs.
- After Part 3: Posters unaffected; enrichment arrives progressively.
- After Part 4: Modal shows progressive sections; no blocking; good keyboard/focus behavior.
- Before demo: Run `npm run build` to verify production compile.

---

## 6. Rollback
- Feature is additive. To disable quickly, short-circuit the client trigger for enrichment and hide enrichment sections in the modal.
