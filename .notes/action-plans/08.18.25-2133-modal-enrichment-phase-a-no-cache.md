# Action Plan: Modal Enrichment — Phase A (No Cache)

## 0. Principles
- Keep steps tiny and verifiable; you confirm after each console/visual check.
- Progressive render; no blocking spinners.
- Use official TMDB/OMDb docs; align with `.docs/knowledge/`.

## 1. Scope
- Enrich modal with ratings (RT, Metacritic, IMDb) and stream-first providers (US-only).
- Implement `movies.enrich` tRPC returning a trimmed payload.
- No caching in this phase.

Out of scope: Rent/Buy/Ads, deep links, migrating `/api/movie-details`.

## 2. Risks & Mitigation
- External timeouts → partials; safe fallbacks in UI.
- Env: dual-read `TMDB_BEARER_TOKEN` or `TMDB_API_KEY`; `OMDB_API_KEY`.

## 3. Steps (Action → Verification)

### Step 1 — Console verify TMDB external_ids
- Action: Add TMDB token helper; implement `fetchExternalIds(type, id)` with 1.5s timeout; add tiny dev route to console.log raw + `imdb_id`.
- Verification (you): Confirm `imdb_id` for one movie and one tv id.

### Step 2 — Console verify OMDb ratings
- Prereq: `OMDB_API_KEY`.
- Action: Implement `fetchOmdbRatings(imdbId)`; parse RT/Metacritic/IMDb strings; console.log raw + parsed.
- Verification (you): Confirm parsed strings look correct; omit missing sources.

### Step 3 — Console verify TMDB watch/providers (US, stream-first)
- Action: Implement `fetchWatchProviders(type, id)`; extract `results.US`; whitelist [Netflix, Prime Video, Max, Disney+, Hulu, Apple TV+, Peacock, Paramount+, Tubi, Freevee]; cap 5; include TMDB `link`; console.log filtered list.
- Verification (you): Confirm order, cap 5, and link.

### Step 4 — Add `movies.enrich` tRPC (no cache)
- Action: Compose the three fetchers; parallelize TMDB calls; call OMDb only if `imdb_id`; return:
```
{
  imdbId?: string,
  ratings?: { rottenTomatoes?: string; metacritic?: string; imdb?: string },
  watch?: { country: 'US'; link?: string; flatrate?: { id: number; name: string; logoPath: string }[] }
}
```
- Verification (you): Call from a simple client; confirm payload shape and partials on forced timeouts.

### Step 5 — UI integration (click-to-open; no quick peek by default)
- Action: In `MovieDetailsModal`, call `movies.enrich` in parallel with `/api/movie-details`. Trigger modal on poster or "More info" click (no hover open). Modal presentation: ~70% width, ~80vh, centered, blurred backdrop, slight glass transparency, fade/scale-in. Progressively render chips + providers row (cap 5); reuse `modalVariants`; hide sections if missing; emoji fallback for icons not yet provided. Keyboard: ESC/X/backdrop close (configurable), focus trap, restore focus to originating poster.
- Verification (you): Visual pass across a few titles; confirm no blocking spinners, no crowding, clear click affordance, and proper focus/close behavior.

### Step 6 — Add Trailer data (after ratings/providers)
- Action: Implement `fetchVideos(type, id)` (TMDB `/{type}/{id}/videos`, 1.5s timeout). Selection policy: prefer `site === 'YouTube'` AND `type === 'Trailer'` AND `official === true`; fallback to first `type === 'Trailer'`; else first available video. Build `trailer` payload `{ site: string; key: string; name: string; url: string }` where `url` is a YouTube watch/embed URL when `site === 'YouTube'`, otherwise fallback to the TMDB video page link. Extend `movies.enrich` response to optionally include `trailer`.
- Verification (you): Console.log raw `/videos` for one known title; confirm the chosen trailer and `url`. Call `movies.enrich` and verify the `trailer` field appears when available and is omitted when none.

## 4. Env
- One of `TMDB_BEARER_TOKEN` or `TMDB_API_KEY`, and `OMDB_API_KEY`.

## 5. Rollback
- Feature is additive; guard UI sections to disable quickly if needed.
