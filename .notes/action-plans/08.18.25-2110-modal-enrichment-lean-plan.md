# Action Plan: Modal Enrichment — Phase B (Caching with Upstash Redis)

## 0. Guiding Principles
- Keep it minimal and execution-focused; each step small and verifiable.
- Use official TMDB/OMDb docs; align with `.docs/knowledge/` terminology.
- Progressive render; no blocking spinners.

## 1. Goal (Scope)
- Add a transparent cache layer to the already-working enrichment (Phase A) using Upstash Redis.
- Keep the `movies.enrich` response shape unchanged; cache is an internal optimization.
- Use TTL/SWR (dossier 7d; ratings 7d; providers 48h). No seed files.

Out of scope: Rent/Buy/Ads, deep links, migrating `/api/movie-details` to tRPC, automated tests.

## 2. Risks & Mitigation
- External timeouts → partials; no UI blocking.
- Env issues → dual-read token helper (`TMDB_BEARER_TOKEN` or `TMDB_API_KEY`); `OMDB_API_KEY` for ratings.
- Rate limits → Redis cache + single-flight per `tmdb:{type}:{id}`.

## 3. Step-by-Step (Action → Verification)

Prerequisite: Phase A (No Cache) completed and `movies.enrich` is functional.

### Step 1 — Add Upstash Redis client
- Action: Configure client with `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN`.
- Verification (you): Ping Redis (SET/GET a test key) and confirm roundtrip.

### Step 2 — Define cache key and dossier shape
- Action: Use key `tmdb:{type}:{id}`; store a trimmed dossier JSON including `imdbId`, `ratings`, `providers.US`, and per-section `updatedAt` fields; set key TTL to 7 days.
- Verification (you): After one enrich call, inspect Redis value to confirm shape and TTL.

### Step 3 — Implement cache-aside with SWR
- Action: On request, check Redis. If hit and fresh (per-section TTLs: providers 48h; ratings 7d), return immediately. If stale/miss, return what’s available and kick off background refresh.
- Verification (you): Force staleness by editing timestamps; observe immediate stale return and background refresh logs.

### Step 4 — Single-flight dedupe
- Action: Use a short Redis lock (e.g., SETNX with 30–60s TTL) keyed by `tmdb:{type}:{id}:lock` to dedupe concurrent builds.
- Verification (you): Trigger concurrent requests; confirm only one upstream fetch via logs.

### Step 5 — Telemetry
- Action: Log cache hits/misses, segment durations (TMDB/OMDb), and OMDb failure counts.
- Verification (you): Generate several requests and review logs for expected metrics.

## 4. Manual checkpoints
- After Step 1, confirm Redis connectivity.
- After Step 2–3, confirm values/TTL in Redis and SWR behavior.
- After Step 4–5, check logs and client latency improvements on repeat loads.

## 5. Telemetry (lightweight)
- Console logs: cache hits/misses, segment durations, OMDb failures.

## 6. Env
- Requires one of `TMDB_BEARER_TOKEN` or `TMDB_API_KEY` (Bearer token); and `OMDB_API_KEY` for ratings.
- Upstash Redis: `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`.

## 7. Rollback
- Gate caching behind a feature flag (e.g., `ENABLE_ENRICH_CACHE=true`). Disable to fall back to Phase A behavior without code changes.
