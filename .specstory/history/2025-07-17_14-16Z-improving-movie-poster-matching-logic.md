<!-- Generated by SpecStory -->

# Improving movie poster matching logic (2025-07-17 14:16Z)

_**User**_

@07.17.25-1012-movie-poster-matching-issue.md @07.17.25-1012-movie-poster-matching-logic-review.md @movie-lookup-issue.md 
Review these two conversation summaries where I had agents try to identify the issue and recommend things.

I am looking for a way to improve these results without having to do some major refactoring. Unless refactoring seems crucial and would dramatically improve the current behavior.

Additionally, I want you to reflect on whether it would be helpful for us to use the following data to make searches more accurate/reliable:
TMDB publishes weekly or something this giant JSON of all the movie IDs, here is an excerpt
{"adult":false,"id":3924,"original_title":"Blondie","popularity":0.4591,"video":false}
{"adult":false,"id":6124,"original_title":"Der Mann ohne Namen","popularity":0.0798,"video":false}
{"adult":false,"id":8773,"original_title":"L'Amour à vingt ans","popularity":0.6643,"video":false}
{"adult":false,"id":25449,"original_title":"New World Disorder 9: Never Enough","popularity":0.1159,"video":false}
{"adult":false,"id":31975,"original_title":"Sesame Street: Elmo Loves You!","popularity":0.0071,"video":true}
{"adult":false,"id":2,"original_title":"Ariel","popularity":1.3321,"video":false}
{"adult":false,"id":3,"original_title":"Varjoja paratiisissa","popularity":1.1965,"video":false}
{"adult":false,"id":5,"original_title":"Four Rooms","popularity":3.3082,"video":false}
{"adult":false,"id":6,"original_title":"Judgment Night","popularity":1.7446,"video":false}
{"adult":false,"id":8,"original_title":"Life in Loops (A Megacities RMX)","popularity":0.3563,"video":false}
{"adult":false,"id":9,"original_title":"Sonntag im August","popularity":0.2169,"video":false}
{"adult":false,"id":11,"original_title":"Star Wars","popularity":24.2055,"video":false}
{"adult":false,"id":12,"original_title":"Finding Nemo","popularity":17.5601,"video":false}
{"adult":false,"id":13,"original_title":"Forrest Gump","popularity":23.4192,"video":false}

Would it be helpful to host that within our app or on our DB and incorporate that in our data flow somehow? It would take the rewrite the pipeline probably where perhaps we'd:
- start by parsing the title from the ai assistant message
- use that information to search in the json and find the exact "id" and then use that id to fetch more details (poster url, etc.)

Not sure it's a good idea since this json id list doesn't have the release year... 

Be critical here.

---

_**Assistant**_

Here’s a critical review and set of recommendations based on your summaries and the idea of using the TMDB movie ID JSON dump:

---

## 1. Review of Summaries & Recommendations

### What’s Working
- **Year inclusion** in AI output helps, but is not always present.
- **Switching to `/search/movie` and `/search/tv`** with year as a parameter is a clear, low-refactor win.
- **Reducing popularity bias** and prioritizing exact title/year matches is a good, targeted improvement.
- **Prompt engineering** to force the AI to always include the year is a practical, non-code fix.

### What’s Not Working
- **Current scoring logic** is too popularity-driven and not strict enough on title/year.
- **Ambiguity** when the year is missing is still a major source of error.
- **Using `/search/multi`** introduces noise (people, collections, etc.).

### What’s Proposed (and Feasible Without Major Refactor)
- Use `/search/movie` and `/search/tv` endpoints, passing the year if available.
- Heavily weight exact title and year matches, with early exit for perfect matches.
- Cap or minimize popularity’s influence.
- Add string similarity for fuzzy matching (Levenshtein, Jaro-Winkler, etc.).
- Expose `year` as a parameter in the tool schema.
- Persist successful (title, year) → TMDB id matches for future lookups.
- Prompt engineering: make year inclusion mandatory.

**All of these can be implemented incrementally, without a major refactor.** The only one that might require a bit more work is persisting (title, year) → TMDB id mappings, but even that can be done as a simple cache/table.

---

## 2. Critique: Using the TMDB Movie ID JSON Dump

### What the Dump Offers
- **Pros:**
  - Fast, local lookup of TMDB IDs by `original_title`.
  - No API rate limits or latency for the initial match.
  - Could be used as a fallback or to pre-populate a cache.

- **Cons:**
  - **No year information.** This is a huge problem for disambiguation (e.g., remakes, sequels, etc.).
  - **No language/variant support.** Only `original_title` is present, not localized titles or alternate names.
  - **No TV shows.** Your excerpt is only movies; if you want to support TV, you’d need a separate dump.
  - **No guarantee of up-to-date data.** The dump is only as current as your last download.
  - **No metadata for filtering.** You can’t filter by genre, release date, etc., without additional API calls.

### Would It Help?
- **For exact, unambiguous titles:** Yes, it could speed up lookups and reduce API calls.
- **For ambiguous titles (remakes, sequels, etc.):** No, it would likely make things worse, since you can’t distinguish between, e.g., “The Thing” (1982) and “The Thing” (2011).
- **For fuzzy matching:** Not really, unless you build a more complex index (e.g., with string similarity search), but you’d still lack year info.

### What Would It Take to Use Effectively?
- You’d need to:
  - Parse the title from the AI message.
  - Search the JSON for exact or fuzzy matches.
  - If multiple matches, you have no way to pick the right one without year or other metadata.
  - Still call the TMDB API to get details (poster, year, etc.) after finding the ID.

### Is It Worth It?
- **As a supplement:** Maybe, as a cache for exact, unambiguous matches, or to reduce API calls for very common titles.
- **As a replacement for API search:** No, because you lose the ability to disambiguate by year, language, or other metadata.
- **For your current problem:** It does not solve the core issue (disambiguation), and could introduce new errors if used as the primary lookup.

---

## 3. Recommendations

### Low-Refactor, High-Impact Steps
- **Switch to `/search/movie` and `/search/tv`** with year as a parameter.
- **Revise scoring:** Early exit for exact title+year, minimize popularity’s role.
- **Add string similarity for fuzzy matches.**
- **Prompt engineering:** Make year inclusion mandatory for the AI.
- **(Optional, but easy):** Cache successful (title, year) → TMDB id lookups.

### On the TMDB JSON Dump
- **Don’t use it as your primary lookup.** It lacks year and other critical metadata.
- **Consider it as a cache** for exact, unambiguous matches, but always fall back to the API for ambiguous cases or when the year is needed.
- **If you want to use it,** you could:
  - Use it to pre-fill a cache of (title, id) for very common, unique titles.
  - Use it to reduce API calls for “safe” lookups, but always verify with the API if there’s any ambiguity.

### If You Want to Go Further (But Not Major Refactor)
- **Persist a mapping table** of (title, year) → TMDB id as you resolve them, to improve future lookups.
- **Expose year as a required parameter** in your tool schema and prompt.

---

## TL;DR

- The JSON dump is not a silver bullet due to lack of year and other metadata.
- Focus on improving your API search logic and prompt engineering for the biggest gains, with minimal refactor.
- Use the dump only as a cache for exact, unambiguous matches, not as your main lookup source.

If you want, I can help you sketch out the minimal code changes for the above recommendations. Let me know!

---

_**User**_

"Expose year as a required parameter in your tool schema and prompt." Say more about that. Look at how we're currently doing that and report back.

---

_**Assistant**_

<details>
            <summary>Searched codebase "Where is the TMDB tool schema defined and how is the 'year' parameter handled or passed?" • **9** results</summary>
        
| File | Lines |
|------|-------|
| `src/app/api/chat-tmdb-tool/route.ts` | L142-188 |
| `src/app/api/chat-tmdb-tool/route.ts` | L104-121 |
| `src/app/api/chat-tmdb-tool/route.ts` | L1-32 |
| `src/app/api/chat-tmdb-tool/route.ts` | L39-104 |
| `src/app/api/chat-tmdb-tool/route.ts` | L121-142 |
| `src/app/api/chat-tmdb-tool/route.ts` | L188-244 |
| `src/app/api/chat-tmdb-tool/route.ts` | L32-36 |
| `src/app/api/chat-tmdb-tool/route.ts` | L244-254 |
| `src/app/api/chat-tmdb-tool/route.ts` | L36-39 |

</details>

---

Read file: src/app/api/chat-tmdb-tool/route.ts

---

Here’s how the "year" parameter is currently handled in your TMDB tool schema and prompt:

---

### 1. Current Tool Schema

In `src/app/api/chat-tmdb-tool/route.ts`, the tool schema for `media_lookup` is defined as:

```ts
parameters: z.object({
  title: z.string().describe('The exact title as written in your response'),
}),
```

- **Only the `title` is required and exposed as a parameter.**
- There is **no explicit `year` parameter** in the schema.

---

### 2. How Year Is Handled

- The year is **not passed as a separate parameter**.
- Instead, the code tries to **extract the year from the title string** using a regex:  
  ```ts
  const yearMatch = /\((\d{4})\)/.exec(title);
  const searchYear = yearMatch?.[1] ? parseInt(yearMatch[1]) : null;
  const cleanTitle = title.replace(/\s*\(\d{4}\)/, '').trim();
  ```
- This means the AI is expected to include the year in parentheses in the title string (e.g., "The Thing (1982)").
- If the year is present, it is used in the scoring logic, but **it is not passed to the TMDB API as a query parameter**—the API call is always to `/search/multi?query=...`, not `/search/movie?query=...&year=...`.

---

### 3. Prompt/Description

- The tool description says:
  > "Call this for every movie/TV show/documentary you recommend by name. Examples: If you mention 'Chef's Table', call with title: 'Chef's Table'. Never skip this step."
- There is **no explicit instruction in the schema or description to include the year as a separate parameter**.

---

## Summary

- **Year is not exposed as a required or optional parameter in the tool schema.**
- The system relies on the AI to include the year in the title string, which is then parsed out with a regex.
- This is fragile and error-prone, as it depends on the AI’s output format and string parsing.

---

## Recommendation

To make year handling robust and reliable:
- **Expose `year` as a separate, required (or at least optional) parameter in the tool schema.**
- Update the tool description and prompt to instruct the AI to always provide the year as a separate field.
- Update the backend logic to use the year parameter directly, and pass it to the TMDB API as a query parameter (e.g., `&year=...` for movies, `&first_air_date_year=...` for TV).

Would you like a concrete example of how to update the schema and logic for this?

---

_**User**_

ok yes interesting. And we do have TMDB endpoints that accept title + year right? The movie and tv show look up ones?

---

_**Assistant**_

<details>
            <summary>Searched web "TMDB API search movie and tv endpoints year parameter documentation" • **6** results</summary>
        
| Title | URL |
|-------|-----|
| Movie | https://developer.themoviedb.org/reference/discover-movie |
| Search - Movies | https://developer.themoviedb.org/reference/search-movie |
| Search & Query For Details | https://developer.themoviedb.org/docs/search-and-query-for-details |
| Search - Multi | https://developer.themoviedb.org/reference/search-multi |
| Release Dates | https://developer.themoviedb.org/reference/movie-release-dates |
| Getting Started | https://developer.themoviedb.org/docs/getting-started |

</details>

---

Yes, TMDB provides endpoints that accept both title and year for more accurate lookups:

### 1. `/search/movie`
- **Endpoint:** `https://api.themoviedb.org/3/search/movie`
- **Parameters:**
  - `query` (string): The movie title.
  - `year` (integer): The year of release to filter results.
  - `primary_release_year` (integer): Also available for more specific filtering.
- **Docs:** [TMDB Search Movie API](https://developer.themoviedb.org/reference/search-movie)

### 2. `/search/tv`
- **Endpoint:** `https://api.themoviedb.org/3/search/tv`
- **Parameters:**
  - `query` (string): The TV show title.
  - `first_air_date_year` (integer): The year the TV show first aired.
- **Docs:** [TMDB Search TV API](https://developer.themoviedb.org/reference/search-tv)

---

**Summary:**  
You can and should use these endpoints with both the title and year parameters for much more precise results, especially for disambiguating remakes, sequels, and similarly titled works.

Would you like a concrete example of how to update your tool schema and backend logic to use these parameters?

---

_**User**_

@gen-action-plan 
you can skip the part about the data dump, we won't use it.

---

_**Assistant**_

Here’s a draft for your action plan to robustly support year-based movie/TV lookups using TMDB’s API, following your notepad protocol and skipping the data dump aspect:

---

# Action Plan: Robust Year-Based TMDB Lookup

## 0. Guiding Principles & Execution Protocol (NEW)
> **This preamble is the most critical part of the plan and must be followed strictly.**

1.  **Immutable Plan**: The agent must follow this plan exactly as written and MUST NOT edit it. If a step is impossible, it must stop and report the issue.
2.  **Documentation is Law**: If the plan involves a library, the primary resource MUST be its official documentation. The agent must use the exact component names and props from the documentation.
3.  **One Step at a Time**: The agent will perform only one "Action" at a time and will only proceed after successfully completing the "Verification" step for that action.

---

## 1. Overall Goal

- Update the movie/TV lookup tool and backend logic to robustly support and require a `year` parameter for TMDB lookups, using the correct TMDB endpoints and query parameters for both movies and TV shows.
- **Out of scope:** Any use of the TMDB data dump, changes to unrelated chat or UI logic, or major refactoring of the chat pipeline.

---

## 2. Regression Risks & Mitigation

- **Risk:** Breaking existing lookups that do not provide a year.
  - **Mitigation:** Make `year` optional in the schema, but always use it if provided.
- **Risk:** Incorrect API parameter usage (e.g., using `year` for TV or `first_air_date_year` for movies).
  - **Mitigation:** Strictly follow TMDB documentation for parameter names.
- **Risk:** Failing to update prompt/tool description, leading to AI not providing year.
  - **Mitigation:** Update both the tool schema and the system prompt to require year.

---

## 3. Structured Action & Verification Plan

### Part 1: Tool Schema & Prompt Update

- **Action 1.1:** Update the `media_lookup` tool schema in `src/app/api/chat-tmdb-tool/route.ts` to accept both `title` (string, required) and `year` (number, required for new logic, but fallback to optional for backward compatibility).
- **Verification 1.1:** Confirm the zod schema and tool description require and document both parameters.

- **Action 1.2:** Update the system prompt/tool description to instruct the AI to always provide the year as a separate parameter when recommending a movie or TV show.
- **Verification 1.2:** Confirm the prompt and tool description explicitly require the year.

### Part 2: Backend Logic Update

- **Action 2.1:** Refactor the backend logic in `media_lookup` to:
  - Use `/search/movie?query=...&year=...` for movies when year is provided.
  - Use `/search/tv?query=...&first_air_date_year=...` for TV when year is provided.
  - Fallback to `/search/movie` or `/search/tv` without year if not provided.
- **Verification 2.1:** Confirm API requests use the correct endpoint and parameter for each media type and year.

- **Action 2.2:** Update the scoring logic to prioritize exact title and year matches, with early exit for perfect matches, and minimize popularity’s influence.
- **Verification 2.2:** Confirm the scoring logic prioritizes exact matches and passes tests for ambiguous titles.

### Part 3: Testing & Regression

- **Action 3.1:** Add or update tests to cover:
  - Movie and TV lookups with and without year.
  - Ambiguous titles (remakes, sequels, etc.).
- **Verification 3.1:** All tests pass and demonstrate correct disambiguation.

- **Action 3.2:** Run `npm run build` to ensure the application compiles without errors.
- **Verification 3.2:** Build completes successfully.

---

**Filename:**  
`.notes/action-plans/07.17.25-robust-tmdb-year-lookup.md` (use actual EST date/time for final file)

Let me know if you want this written to disk or want to adjust any step!

---

_**User**_

create the file

---

_**Assistant**_

```bash
date +'%m.%d.%y-%H%M'
```

```
➜  week2-chatbot git:(main) ✗ date +'%m.%d.%y-%H%M'
07.17.25-1044
➜  week2-chatbot git:(main) ✗
```

---

```diff
- 
+ # Action Plan: Robust Year-Based TMDB Lookup
+ 
+ ## 0. Guiding Principles & Execution Protocol (NEW)
+ > **This preamble is the most critical part of the plan and must be followed strictly.**
+ 
+ 1.  **Immutable Plan**: The agent must follow this plan exactly as written and MUST NOT edit it. If a step is impossible, it must stop and report the issue.
+ 2.  **Documentation is Law**: If the plan involves a library, the primary resource MUST be its official documentation. The agent must use the exact component names and props from the documentation.
+ 3.  **One Step at a Time**: The agent will perform only one "Action" at a time and will only proceed after successfully completing the "Verification" step for that action.
+ 
+ ---
+ 
+ ## 1. Overall Goal
+ 
+ - Update the movie/TV lookup tool and backend logic to robustly support and require a `year` parameter for TMDB lookups, using the correct TMDB endpoints and query parameters for both movies and TV shows.
+ - **Out of scope:** Any use of the TMDB data dump, changes to unrelated chat or UI logic, or major refactoring of the chat pipeline.
+ 
+ ---
+ 
+ ## 2. Regression Risks & Mitigation
+ 
+ - **Risk:** Breaking existing lookups that do not provide a year.
+   - **Mitigation:** Make `year` optional in the schema, but always use it if provided.
+ - **Risk:** Incorrect API parameter usage (e.g., using `year` for TV or `first_air_date_year` for movies).
+   - **Mitigation:** Strictly follow TMDB documentation for parameter names.
+ - **Risk:** Failing to update prompt/tool description, leading to AI not providing year.
+   - **Mitigation:** Update both the tool schema and the system prompt to require year.
+ 
+ ---
+ 
+ ## 3. Structured Action & Verification Plan
+ 
+ ### Part 1: Tool Schema & Prompt Update
+ 
+ - **Action 1.1:** Update the `media_lookup` tool schema in `src/app/api/chat-tmdb-tool/route.ts` to accept both `title` (string, required) and `year` (number, required for new logic, but fallback to optional for backward compatibility).
+ - **Verification 1.1:** Confirm the zod schema and tool description require and document both parameters.
+ 
+ - **Action 1.2:** Update the system prompt/tool description to instruct the AI to always provide the year as a separate parameter when recommending a movie or TV show.
+ - **Verification 1.2:** Confirm the prompt and tool description explicitly require the year.
+ 
+ ### Part 2: Backend Logic Update
+ 
+ - **Action 2.1:** Refactor the backend logic in `media_lookup` to:
+   - Use `/search/movie?query=...&year=...` for movies when year is provided.
+   - Use `/search/tv?query=...&first_air_date_year=...` for TV when year is provided.
+   - Fallback to `/search/movie` or `/search/tv` without year if not provided.
+ - **Verification 2.1:** Confirm API requests use the correct endpoint and parameter for each media type and year.
+ 
+ - **Action 2.2:** Update the scoring logic to prioritize exact title and year matches, with early exit for perfect matches, and minimize popularity’s influence.
+ - **Verification 2.2:** Confirm the scoring logic prioritizes exact matches and passes tests for ambiguous titles.
+ 
+ ### Part 3: Testing & Regression
+ 
+ - **Action 3.1:** Add or update tests to cover:
+   - Movie and TV lookups with and without year.
+   - Ambiguous titles (remakes, sequels, etc.).
+ - **Verification 3.1:** All tests pass and demonstrate correct disambiguation.
+ 
+ - **Action 3.2:** Run `npm run build` to ensure the application compiles without errors.
+ - **Verification 3.2:** Build completes successfully. 
```

---

The action plan file has been created at:

```
.notes/action-plans/07.17.25-1044-robust-tmdb-year-lookup.md
```

It follows your protocol and outlines the step-by-step approach for robust, year-based TMDB lookups, with the data dump aspect excluded as requested. Let me know when you’re ready to begin the first action or if you want to review or adjust any part of the plan!

---

